// ====================
// import
// ====================
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
// 【変更点1】VRMLoaderPlugin を読み込みます
import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';


// ====================
// モデル名定義
// ====================

const modelName = 'model.vrm';

// ====================
// シーン設定
// ====================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xeeeeee);

// ====================
// カメラ設定
// ====================
const camera = new THREE.PerspectiveCamera(
  30,
  window.innerWidth / window.innerHeight,
  0.1,
  20
);
camera.position.set(0, 1.4, 2.5);

// ====================
// レンダラー設定
// ====================
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputColorSpace = THREE.SRGBColorSpace; 

//トーンマッピング
// これを入れることで、光を強くしても「白飛び」しにくくなり、
// 全体的に明るく自然な色合いになります。
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0; // 露出レベル

document.body.appendChild(renderer.domElement);

// ====================
// マウス操作
// ====================
const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 1.3, 0);
controls.update();

// ====================
// ライト設定
// ====================
scene.add(new THREE.AmbientLight(0xffffff, 2.0));
const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
dirLight.position.set(1, 2, 1).normalize();

// もし影（シャドウ）を落としたい場合は以下を有効化
// dirLight.castShadow = true;

scene.add(dirLight);

// ====================
// VRM 読み込み (ここが大きく変わりました)
// ====================
const loader = new GLTFLoader();
const clock = new THREE.Clock();

// 【変更点2】ローダーにVRM読み込み機能（プラグイン）を追加
loader.register((parser) => {
  return new VRMLoaderPlugin(parser);
});

loader.load(
  `./vrm/${modelName}`,
  (gltf) => {
    // 新しいバージョンでは、読み込み完了後に gltf.userData.vrm にVRMが入っています
    const vrm = gltf.userData.vrm;

    // もしVRMじゃなかった場合（ただのGLTFだった場合）のエラー回避
    if (!vrm) {
        console.error('VRMの読み込みに失敗しました（vrmデータが見つかりません）');
        return;
    }

    // 不要なジョイントの削除（最適化）
    VRMUtils.removeUnnecessaryJoints(gltf.scene);

    // シーンに追加（vrm.scene を追加します）
    scene.add(vrm.scene);
    
    // 授業用変数
    window.currentVrm = vrm;
    console.log('VRM Loaded!');
  },
  (progress) => {
    console.log(`Loading... ${Math.round(100.0 * (progress.loaded / progress.total))}%`);
  },
  (error) => {
    console.error(error);
  }
);

// ====================
// アニメーションループ
// ====================
function animate() {
  requestAnimationFrame(animate);

  const deltaTime = clock.getDelta();

  if (window.currentVrm) {
    window.currentVrm.update(deltaTime);
  }

  renderer.render(scene, camera);
}

animate();

// ====================
// リサイズ対応
// ====================
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});